{% extends 'base.html' %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2 class="text-center">Login</h2>
        <div class="card">
            <div class="card-body">
                <form id="loginForm" method="post">
                    {% csrf_token %}
                    {% comment %} <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" class="form-control" id="username" name="username" placeholder="Enter username" required>
                    </div> {% endcomment %}
                    <div class="form-group">
                        <label for="email">Email address</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="Enter email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                </form>
                <p id="loginMessage" class="mt-3 text-center"></p>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('loginForm').onsubmit = async function(e){
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            username: formData.get('email'), // You are correctly sending the email as 'username'
            password: formData.get('password')
        };
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Use the 'url' tag to get the correct path from urls.py
        const res = await fetch("{% url 'api_login' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
    
        const result = await res.json();
        if(result.access){
            localStorage.setItem('access', result.access);
            localStorage.setItem('refresh', result.refresh);
            window.location.href = "{% url 'feeds_page' %}";
        } else {
            document.getElementById('loginMessage').innerText = "Invalid username or password"; // Display a generic error
        }
    };
    </script>
{% comment %} <script>
document.getElementById('loginForm').onsubmit = async function(e){
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
        username: formData.get('email'),
        password: formData.get('password')
    };
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const res = await fetch('/api/login/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    });
    const result = await res.json();
    if(result.access){
        localStorage.setItem('access', result.access);
        localStorage.setItem('refresh', result.refresh);
        window.location.href = "{% url 'feeds_page' %}";
    } else {
        document.getElementById('loginMessage').innerText = result.error;
    }
};
</script> {% endcomment %}
{% endblock %}
